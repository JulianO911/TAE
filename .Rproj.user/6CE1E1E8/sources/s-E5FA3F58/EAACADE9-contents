---
title: "Depuracion Base de Datos para el Trabajo #1 de Estadistica Descriptiva"
author: "David Garcia Blandon"
date: "23/10/2020"
output: 
  html_document: 
    css: Estilo.css
    toc: yes
    highlight: haddock
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
```

```{r library import}
library('summarytools')
library('tidyverse')
library('sf')
library('OpenStreetMap')
library('osmdata')
library('ggmap')
```

```{r read DB}
acc_Motos <- read.csv('./Datos/Accidentalidad_con_motos_municipio_de_Medell_n_actualizado_a_julio_2020.csv', header=T, fileEncoding = "UTF-8", na.strings=c(""))
load("./Datos/DireccionesUnicas.RData")
comunas <- read_sf("./Datos/LimiteComunaCorregimiento/LimiteComunaCorregimiento.shp")
mapa_Med <- get_map(getbb("Medellin"), maptype="roadmap", source = "osm")
```

# Estado de la Base de datos Antes de la depuracion

- La base de datos posee 9 variables y 145456 registros, de los cuales solo 6
tienen datos faltantes, de las variables las únicas que presentan inconvenientes
son la hora y la fecha.

- En la fecha los registros por error traen añadido una hora que es ilógica ya
que la fuente nos informa que de esa variable el único dato de interés es la fecha,
y se puede observar que al ser la misma hora en todos los registros esta hora no
tiene ningún sentido.

- En la hora hay algunos registros que fuera de tener la hora también presentan
una fecha que es ilógica ya que la fuente nos informa que de esa variable el único
dato de interés es la hora, y obviamente la fecha no se encuentra en el periodo
de tiempo definido de esta base de datos por la fuente, esto también podría haber
sido resultado de un traslado de otra base de datos que le puso esa otra fecha
por equivocación.

- En las zonas hay mucha arbitrariedad en su delineamiento, ya que se toma como
delimitación principal a las comunas de Medellín, pero en práctica hay registros
a los cuales se le asigna al lugar donde ocurre como la zona en vez de la comuna
en la que el lugar se encuentra.

- Hay Direcciones Invalidas que no pertenecen a ningún lugar.

## Resumen de la Base de Datos modificada

```{r summary before modification}
options(width = 170, encoding = "UTF-8")
dfSummary(acc_Motos)
```

# Depuracion de la base de datos

1. se convierten a factores las variables: 

  * NRO_RADICADO, 
  * AÑO_ACCIDENTE, 
  * CLASE_ACCIDENTE, 
  * GRAVEDAD_ACCIDENTE,
  * ZONA, 
  * Diseño.Via.

2. De la fecha se observa que posee hora más esa hora no es de interés, parece ser
que le quedo asignada como default al exportar las fechas a la base de datos,
por lo que convierto la variable a tipo fecha y excluyo las horas de la conversión.

  * Ejemplo:
    (Antes) 01/01/2015 12:00:00 AM  =>  (después)  2015-01-01

3. De la hora se observa que viene de dos variedades, la hora sola, y la hora con
una fecha que se observa que no es lógica. por lo que a través de las expresiones
regulares (REGEX) extraigo solo la parte de  la hora que nos interesa. Se observa
que la hora ya viene en formato de 24 horas.

  * Ejemplo:
    (Antes) 00:30:00  =>  (después)  00:30:00
    (Antes) 1899-12-31T15:10:00.000  =>  (después)  15:10:00

  * expresión Regular: "\\d{2}\\:{1}\\d{2}\\:{1}\\d{2}"

4. Con la fecha y la hora en su correcto formato formamos una nueva variable
FECHA_COMPLETA que me junta los 2 valores en una sola columna en un formato
de tiempo POSIXct.

5. Cree una nueva variable que le asigna un valor numérico discreto a la gravedad
de un accidente.

6. Se añadieron las columnas con la longitud y latitud ya codificadas a través de
un left join. Para conseguir el archivo .RData con el cual se hace el join, se
adjunta un rmarkdown donde se explica cómo generar este archivo a partir de la
base de datos original. (el archivo .RData de igual manera ya viene adjunto)

7. Se creo una nueva variable a la que se le asigna el día de la semana en el que
ocurrió el accidente.

8. se creó una nueva variable que almacena la hora de forma continua.

9. se consiguió un croquis de las comunas de Medellín en un archivo SHP del 2014 de
la secretaria de Medellín, 

  + Fuente: https://www.medellin.gov.co/geonetwork/srv/spa/catalog.search#/metadata/27e73f95-b2e8-4519-8644-6345a65bc0f5

10. se consigue un mapa de las calles de Medellín, 

  + Fuente: OSM.

11. Decidí eliminar las filas con datos faltantes o no validos ya que eran
demasiado pocas las que tenían datos faltantes. (CON NA)

12. Decidí eliminar los registros con radicado repetido, ya que no es lógico que
un accidente ocurra 2 veces.

12. Se reduje las zonas a solo:

  +  Las comunas de Medellín (1-16), 
  +  Los corregimientos bajo la jurisdicción de Medellín (4), 
  +  Las carreteras bajo la jurisdicción se reunieron dentro de una sola zona
  +  Las otras zonas o se reacomodaron a las zonas anteriores o se les asigno 'ZONA DESCONOCIDA'
  
*Se hace claridad en cuanto la geo codificación, en la base de datos original se
pueden encontrar 28514 direcciones únicas, de las cuales a través de la aplicación
del sitio web:
    'https://www.medellin.gov.co/geomedellin/index.hyg#divAplicaciones'
nos permitió geo codificar un 56% de las direcciones únicas, que al momento de
reunirlas con la base de datos original nos proyecta que un 78% de los registros
quedaron geo codificados.

**no se depuro la variable DIRECCION ya que en su único uso a la hora de generar
la geo codificación no hubo necesidad de realizar dicha depuración.

***El archivo adjunto para la creación del .RData de direcciones únicas se encuentra en la raíz del proyecto con el nombre de 'direccionador.Rmd'.


```{r radicados repetidos}
radicados <- acc_Motos %>% 
  group_by(NRO_RADICADO) %>% 
  summarise(num_accidentes = n()) %>% 
  arrange(desc(num_accidentes)) %>% 
  slice(1:5)
```

```{r arreglar las zonas}
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 1"] = "Comuna 1"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 2"] <- "Comuna 2"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 3"] <- "Comuna 3"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 4"] <- "Comuna 4"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 5"] <- "Comuna 5"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 6"] <- "Comuna 6"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 7"] <- "Comuna 7"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 8"] <- "Comuna 8"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 9"] <- "Comuna 9"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 10"] <- "Comuna 10"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 11"] <- "Comuna 11"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 12"] <- "Comuna 12"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 13"] <- "Comuna 13"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 14"] <- "Comuna 14"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 15"] <- "Comuna 15"
acc_Motos$ZONA[acc_Motos$ZONA=="COMUNA 16"] <- "Comuna 16"
acc_Motos$ZONA[acc_Motos$ZONA=="NORTE"] <- "Comuna 3"
acc_Motos$ZONA[acc_Motos$ZONA=="TERMINAL NORTE"] <- "Comuna 5"
acc_Motos$ZONA[acc_Motos$ZONA=="PARQUE BERRIO"] <- "Comuna 10"
acc_Motos$ZONA[acc_Motos$ZONA=="CENTRO"] <- "Comuna 10"
acc_Motos$ZONA[acc_Motos$ZONA=="ALPUJARRA"] <- "Comuna 10"
acc_Motos$ZONA[acc_Motos$ZONA=="LA MINORISTA"] <- "Comuna 10"
acc_Motos$ZONA[acc_Motos$ZONA=="LAURELES"] <- "Comuna 11"
acc_Motos$ZONA[acc_Motos$ZONA=="EL POBLADO"] <- "Comuna 14"
acc_Motos$ZONA[acc_Motos$ZONA=="LAS VEGAS"] <- "Comuna 14"
acc_Motos$ZONA[acc_Motos$ZONA=="TERMNAL SUR"] <- "Comuna 15"
acc_Motos$ZONA[acc_Motos$ZONA=="LA MOTA"] <- "Comuna 16"
acc_Motos$ZONA[acc_Motos$ZONA=="OTRAS ENTIDADES"] <- "ZONA DESCONOCIDA"
acc_Motos$ZONA[acc_Motos$ZONA=="CARRETERA AL MAR Jurisdicción"] <- "CARRETERA Jurisdiccion"
acc_Motos$ZONA[acc_Motos$ZONA=="CARRETERA LAS PALMAS Jurisdicción"] <- "CARRETERA Jurisdiccion"
acc_Motos$ZONA[acc_Motos$ZONA=="CARRETERA SAN PEDRO Jurisdicción"] <- "CARRETERA Jurisdiccion"
acc_Motos$ZONA[acc_Motos$ZONA=="CARRETERA SANTA ELENA Jurisdicción"] <- "CARRETERA Jurisdiccion"
acc_Motos$ZONA[acc_Motos$ZONA=="VIA TUNEL DE OCCIDENTE"] <- "CARRETERA Jurisdiccion"
acc_Motos$ZONA[acc_Motos$ZONA=="ZONA 4"] <- "Comuna 14"
acc_Motos$ZONA[acc_Motos$ZONA=="LA DIEZ"] <- "ZONA DESCONOCIDA"
acc_Motos$ZONA[acc_Motos$ZONA=="AV REGIONAL"] <- "Comuna 15"
acc_Motos$ZONA[acc_Motos$ZONA=="LA MAYORISTA"] <- "ZONA DESCONOCIDA"
acc_Motos$ZONA[acc_Motos$ZONA=="OCCIDENTE"] <- "ZONA DESCONOCIDA"
acc_Motos$ZONA[acc_Motos$ZONA=="ORIENTE"] <- "ZONA DESCONOCIDA"
acc_Motos$ZONA[acc_Motos$ZONA=="."] <- "ZONA DESCONOCIDA"
```

```{r Zonas para el crokis}
acc_Motos <- acc_Motos %>% mutate(IDENTIFICA = ZONA)
acc_Motos$IDENTIFICA[acc_Motos$ZONA=="CORREGIMIENTO PALMITAS Jurisdicción"] <- "Corregimiento 50"
acc_Motos$IDENTIFICA[acc_Motos$ZONA=="CORREGIMIENTO SAN CRISTOBAL Jurisdicción"] <- "Corregimiento 60"
acc_Motos$IDENTIFICA[acc_Motos$ZONA=="CORREGI. BELEN ALTAVISTA Jurisdicción"] <- "Corregimiento 70"
acc_Motos$IDENTIFICA[acc_Motos$ZONA=="CORREGIMIENTO SANTA ELENA Jurisdicción"] <- "Corregimiento 80"
acc_Motos$IDENTIFICA[acc_Motos$ZONA=="SAN ANTONIO DE PRADO Jurisdicción"] <- "Corregimiento 90"
```

```{r DB modifications}
acc_M <- acc_Motos %>%
  mutate(NRO_RADICADO = factor(NRO_RADICADO),
         AÑO_ACCIDENTE = factor(AÑO_ACCIDENTE),
         FECHA_ACCIDENTE = as.Date(FECHA_ACCIDENTE, "%m/%d/%Y"),
         HORA_ACCIDENTE = str_extract(HORA_ACCIDENTE, "\\d{2}\\:{1}\\d{2}\\:{1}\\d{2}"),
         FECHA_COMPLETA = as.POSIXct(strptime(strftime(paste(FECHA_ACCIDENTE, HORA_ACCIDENTE), 
                                                       "%m-%d-%Y %H:%M:%S"), "%m-%d-%Y %H:%M:%S")),
         CLASE_ACCIDENTE = factor(CLASE_ACCIDENTE),
         GRAVEDAD_ACCIDENTE = factor(GRAVEDAD_ACCIDENTE, levels = c("SOLO DAÑOS","HERIDO","MUERTO")),
         ZONA = factor(ZONA, levels = c("Comuna 1","Comuna 2","Comuna 3","Comuna 4","Comuna 5","Comuna 6","Comuna 7",      "Comuna 8","Comuna 9","Comuna 10","Comuna 11","Comuna 12","Comuna 13","Comuna 14","Comuna 15","Comuna 16","CORREGIMIENTO PALMITAS Jurisdicción","CORREGIMIENTO SAN CRISTOBAL Jurisdicción","CORREGI. BELEN ALTAVISTA Jurisdicción","CORREGIMIENTO SANTA ELENA Jurisdicción","SAN ANTONIO DE PRADO Jurisdicción","Jurisdicción","CARRETERA Jurisdiccion","ZONA DESCONOCIDA")),
         IDENTIFICA = factor(IDENTIFICA, levels = c("Comuna 1","Comuna 2","Comuna 3","Comuna 4","Comuna 5","Comuna 6","Comuna 7",      "Comuna 8","Comuna 9","Comuna 10","Comuna 11","Comuna 12","Comuna 13","Comuna 14","Comuna 15","Comuna 16","Corregimiento 50","Corregimiento 60","Corregimiento 70","Corregimiento 80","Corregimiento 90","Jurisdicción","CARRETERA Jurisdiccion","ZONA DESCONOCIDA")),
         Diseño.Vía = factor(Diseño.Vía),
         GRAVEDAD = ifelse(GRAVEDAD_ACCIDENTE=="MUERTO",5,ifelse(GRAVEDAD_ACCIDENTE=="HERIDO",3,1)),
         Dia.Semana = factor(c("Domingo", "Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado")[as.POSIXlt(FECHA_COMPLETA)$wday + 1], levels=c("Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado","Domingo")),
         Hora.Continua= as.numeric(format(FECHA_COMPLETA, "%H")) + as.numeric(format(FECHA_COMPLETA, "%M"))/60) %>%
  filter(!(NRO_RADICADO %in% radicados$NRO_RADICADO)) %>%
  drop_na() %>% left_join(DirUnicas, keep=TRUE)
```

```{r BD punto 1}
acc_Zona <- acc_M %>% group_by(ZONA,AÑO_ACCIDENTE) %>% summarise(num_accidentes = n()) %>% arrange()
```

```{r BD punto 2}
acc_promedio_zona <- acc_M %>% 
  group_by(IDENTIFICA,GRAVEDAD) %>% 
  summarise(num=n()) %>% 
  mutate(gravity = GRAVEDAD*num) %>% 
  summarise(grv= sum(gravity), total=sum(num)) %>% 
  group_by(IDENTIFICA,total) %>% 
  summarise(Ponderado = grv/total)
Zonas <- left_join(comunas,acc_promedio_zona, keep=TRUE)
st_crs(Zonas) <- 3116
Zonas <- st_transform(Zonas, crs = 4326)
```

```{r BD punto 3}
acc_xy <-  acc_M %>% select(AÑO_ACCIDENTE,GRAVEDAD,longitud, latitud) %>% filter(!is.na(longitud) | !is.na(latitud))
acc_xy <- st_as_sf(acc_xy, coords = c("longitud", "latitud"), crs = 4326)
```

```{r BD punto 4}
acc_Hora <- acc_M %>% select(Dia.Semana,GRAVEDAD_ACCIDENTE,Hora.Continua)
```

```{r BD punto 5}
acc_via <- acc_M %>% 
  group_by(Diseño.Vía,GRAVEDAD) %>% 
  summarise(num=n()) %>% 
  mutate(gravity = GRAVEDAD*num) %>% 
  summarise(grv= sum(gravity), total=sum(num)) %>% 
  group_by(Diseño.Vía,total) %>% 
  summarise(Ponderado = grv/total)
```

## Resumen de la Base de Datos depurada

```{r summary after modification}
options(width = 170, encoding = "UTF-8")
dfSummary(acc_M)
```

## Mapa de las calles de medellin

```{r}
ggmap(mapa_Med)
```

## Croquis de las comunas de medellin y los corregimientos bajo su jurisdiccion

```{r}
ggplot(Zonas)+geom_sf()
```

```{r saving in .Rdata file}
save(acc_M, acc_Zona, Zonas, acc_xy, acc_Hora, acc_via, mapa_Med, file = "./Datos/Accidentalidad_Motos_Medellin.RData")
```

```{r clear workspace}
rm(list = ls())
```